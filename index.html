<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ‰‹æ©Ÿå‹å–„ç´”å‰ç«¯è¨˜å¸³ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: sans-serif;
    background: #222;
    color: #eee;
    margin: 10px;
    padding: 0;
  }
  .container {
    max-width: 480px;
    margin: auto;
    background: #333;
    padding: 15px;
    border-radius: 8px;
    box-sizing: border-box;
  }
  input, select, button {
    width: 100%;
    margin: 10px 0;
    padding: 14px;
    border-radius: 8px;
    border: none;
    font-size: 18px;
    box-sizing: border-box;
  }
  button {
    background: #0b0;
    color: #fff;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
  }
  button:hover {
    background: #090;
  }
  h2, h3 {
    margin: 12px 0 6px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #444;
    font-size: 16px;
    overflow-x: auto;
    display: block;
  }
  thead tr {
    background: #555;
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  tbody {
    display: block;
    max-height: 250px;
    overflow-y: auto;
    width: 100%;
  }
  tbody tr {
    display: table;
    width: 100%;
    table-layout: fixed;
    border-bottom: 1px solid #666;
  }
  th, td {
    padding: 10px 6px;
    text-align: center;
    word-break: break-word;
  }
  .btn-small {
    font-size: 14px;
    padding: 6px 10px;
    margin: 0 2px;
    border-radius: 6px;
  }
  .btn-edit {
    background: #2196f3;
    color: white;
    border: none;
  }
  .btn-delete {
    background: #f44336;
    color: white;
    border: none;
  }
  #app-area > div {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 16px;
  }
  canvas {
    width: 100% !important;
    height: auto !important;
  }
</style>
</head>
<body>
<div class="container">

<h2>ç™»å…¥</h2>
<div id="login-area">
  <input type="text" id="login-username" placeholder="è¼¸å…¥å¸³è™Ÿ" autocomplete="username"/>
  <button onclick="login()">ç™»å…¥</button>
</div>

<div id="app-area" style="display:none;">
  <h2>å¸³è™Ÿï¼š<span id="user-label"></span> <button onclick="logout()">ç™»å‡º</button></h2>

  <div>
    <strong>å¸³æˆ¶åˆå§‹é¤˜é¡ï¼š</strong> <span id="initial-balance">0</span><br/>
    <strong>æ”¯å‡ºï¼š</strong> <span id="total-cost">0</span><br/>
    <strong>æ”¶å…¥ï¼š</strong> <span id="total-income">0</span><br/>
    <strong>åˆ©æ½¤ï¼š</strong> <span id="total-profit">0</span><br/>
    <strong>ç›®å‰é¤˜é¡(åˆå§‹ + åˆ©æ½¤)ï¼š</strong> <span id="current-balance">0</span>
  </div>

  <h3>æ–°å¢è¨˜éŒ„</h3>
  <select id="type" aria-label="é¡å‹">
    <option value="income">æ”¶å…¥</option>
    <option value="cost">æ”¯å‡º</option>
  </select>
  <select id="category" aria-label="åˆ†é¡">
    <option>é£Ÿç‰©</option>
    <option>å¨›æ¨‚</option>
    <option>å·¥å…·</option>
    <option>å…¶ä»–</option>
  </select>
  <input type="number" id="amount" placeholder="é‡‘é¡" aria-label="é‡‘é¡" />
  <input type="text" id="note" placeholder="å‚™è¨»" aria-label="å‚™è¨»" />
  <button onclick="addRecord()" aria-label="æ–°å¢è¨˜éŒ„">æ–°å¢</button>

  <h3>è¨˜éŒ„åˆ—è¡¨</h3>
  <table>
    <thead><tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>åˆ†é¡</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="record-table-body"></tbody>
  </table>

  <h3>çµ±è¨ˆåœ–</h3>
  <canvas id="pieChart" height="200" aria-label="åœ“é¤…åœ–çµ±è¨ˆ" role="img"></canvas>
</div>

<script>
  let currentUser = null;
  let records = [];
  let editingIndex = -1;
  let pieChart = null;
  let initialBalance = 0;

  function login() {
    const username = document.getElementById('login-username').value.trim();
    if(!username) { alert('è«‹è¼¸å…¥å¸³è™Ÿ'); return; }
    currentUser = username;
    document.getElementById('user-label').textContent = currentUser;
    document.getElementById('login-area').style.display = 'none';
    document.getElementById('app-area').style.display = 'block';

    loadInitialBalance();
    loadData();
    render();
  }

  function loadInitialBalance() {
    let bal = localStorage.getItem('initialBalance_' + currentUser);
    if(bal === null) {
      bal = prompt('è«‹è¼¸å…¥å¸³æˆ¶åˆå§‹é¤˜é¡(é è¨­0)', '0');
      if(bal === null || isNaN(parseFloat(bal))) bal = '0';
      localStorage.setItem('initialBalance_' + currentUser, bal);
    }
    initialBalance = parseFloat(bal);
    document.getElementById('initial-balance').textContent = initialBalance.toLocaleString();
  }

  function logout() {
    if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
      currentUser = null;
      records = [];
      editingIndex = -1;
      initialBalance = 0;
      document.getElementById('login-area').style.display = 'block';
      document.getElementById('app-area').style.display = 'none';
      document.getElementById('login-username').value = '';
      clearInputs();
    }
  }

  function loadData() {
    const dataStr = localStorage.getItem('records_' + currentUser);
    if(dataStr) {
      records = JSON.parse(dataStr);
    } else {
      records = [];
    }
  }

  function saveData() {
    localStorage.setItem('records_' + currentUser, JSON.stringify(records));
  }

  function clearInputs() {
    document.getElementById('type').value = 'income';
    document.getElementById('category').value = 'é£Ÿç‰©';
    document.getElementById('amount').value = '';
    document.getElementById('note').value = '';
    editingIndex = -1;
    document.querySelector('button[onclick="addRecord()"]').textContent = 'æ–°å¢';
  }

  function addRecord() {
    const type = document.getElementById('type').value;
    const category = document.getElementById('category').value;
    const amount = parseFloat(document.getElementById('amount').value);
    const note = document.getElementById('note').value.trim();
    const date = new Date().toISOString().split('T')[0];

    if(isNaN(amount) || amount <= 0) {
      alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
      return;
    }

    if(editingIndex === -1) {
      records.push({type, category, amount, note, date});
    } else {
      records[editingIndex] = {type, category, amount, note, date};
      editingIndex = -1;
      document.querySelector('button[onclick="addRecord()"]').textContent = 'æ–°å¢';
    }

    saveData();
    render();
    clearInputs();
  }

  function render() {
    const tbody = document.getElementById('record-table-body');
    tbody.innerHTML = '';
    let totalIncome = 0;
    let totalCost = 0;
    let categoryTotals = {};

    records.forEach((r, i) => {
      let tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.type==='income'?'æ”¶å…¥':'æ”¯å‡º'}</td>
        <td>${r.category}</td>
        <td>${r.amount}</td>
        <td>${r.note}</td>
        <td>
          <button class="btn-small btn-edit" onclick="editRecord(${i})" aria-label="ç·¨è¼¯ç¬¬${i+1}ç­†è¨˜éŒ„">âœï¸</button>
          <button class="btn-small btn-delete" onclick="deleteRecord(${i})" aria-label="åˆªé™¤ç¬¬${i+1}ç­†è¨˜éŒ„">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);

      if(r.type === 'income') totalIncome += r.amount;
      else totalCost += r.amount;

      if(!categoryTotals[r.category]) categoryTotals[r.category] = 0;
      categoryTotals[r.category] += (r.type === 'income' ? r.amount : -r.amount);
    });

    document.getElementById('total-income').textContent = totalIncome.toLocaleString();
    document.getElementById('total-cost').textContent = totalCost.toLocaleString();
    const profit = totalIncome - totalCost;
    document.getElementById('total-profit').textContent = profit.toLocaleString();

    const currentBalance = initialBalance + profit;
    document.getElementById('current-balance').textContent = currentBalance.toLocaleString();

    drawChart(categoryTotals);
  }

  function editRecord(index) {
    const r = records[index];
    document.getElementById('type').value = r.type;
    document.getElementById('category').value = r.category;
    document.getElementById('amount').value = r.amount;
    document.getElementById('note').value = r.note;
    editingIndex = index;
    document.querySelector('button[onclick="addRecord()"]').textContent = 'æ›´æ–°';
  }

  function deleteRecord(index) {
    if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†è¨˜éŒ„å—ï¼Ÿ')) {
      records.splice(index,1);
      saveData();
      render();
    }
  }

  function drawChart(data) {
    const labels = Object.keys(data);
    const values = labels.map(k => Math.abs(data[k]));
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(document.getElementById('pieChart'), {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: ['#f44336', '#2196f3', '#ff9800', '#4caf50', '#9c27b0', '#00bcd4']
        }]
      }
    });
  }
</script>

</div>
</body>
</html>
