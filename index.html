<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>純前端記帳系統 (含帳戶餘額)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; background:#222; color:#eee; margin:20px; }
  .container { max-width: 700px; margin: auto; background:#333; padding: 20px; border-radius: 8px; }
  input, select, button { width: 100%; margin: 8px 0; padding: 10px; border-radius: 5px; border:none; }
  button { background:#0b0; color:#fff; cursor:pointer; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; background:#444; }
  th, td { padding: 8px; border: 1px solid #555; text-align: center; }
  .btn-small { padding: 4px 8px; margin: 0 2px; cursor:pointer; }
  .btn-edit { background: #2196f3; color: white; border: none; border-radius: 3px; }
  .btn-delete { background: #f44336; color: white; border: none; border-radius: 3px; }
</style>
</head>
<body>
<div class="container">

<h2>登入</h2>
<div id="login-area">
  <input type="text" id="login-username" placeholder="輸入帳號" />
  <button onclick="login()">登入</button>
</div>

<div id="app-area" style="display:none;">
  <h2>帳號：<span id="user-label"></span> <button onclick="logout()">登出</button></h2>

  <div>
    <strong>帳戶初始餘額：</strong> <span id="initial-balance">0</span><br/>
    <strong>已使用(支出)：</strong> <span id="total-cost">0</span><br/>
    <strong>已賺(收入)：</strong> <span id="total-income">0</span><br/>
    <strong>利潤：</strong> <span id="total-profit">0</span><br/>
    <strong>目前餘額(初始 + 利潤)：</strong> <span id="current-balance">0</span>
  </div>

  <h3>新增記錄</h3>
  <select id="type">
    <option value="income">收入（賣出）</option>
    <option value="cost">支出（成本）</option>
  </select>
  <select id="category">
    <option>食物</option>
    <option>娛樂</option>
    <option>工具</option>
    <option>其他</option>
  </select>
  <input type="number" id="amount" placeholder="金額" />
  <input type="text" id="note" placeholder="備註" />
  <button onclick="addRecord()">新增</button>

  <h3>記錄列表</h3>
  <table>
    <thead><tr><th>日期</th><th>類型</th><th>分類</th><th>金額</th><th>備註</th><th>操作</th></tr></thead>
    <tbody id="record-table-body"></tbody>
  </table>

  <h3>統計圖</h3>
  <canvas id="pieChart" height="200"></canvas>
</div>

<script>
  let currentUser = null;
  let records = [];
  let editingIndex = -1;
  let pieChart = null;
  let initialBalance = 0;

  function login() {
    const username = document.getElementById('login-username').value.trim();
    if(!username) { alert('請輸入帳號'); return; }
    currentUser = username;
    document.getElementById('user-label').textContent = currentUser;
    document.getElementById('login-area').style.display = 'none';
    document.getElementById('app-area').style.display = 'block';

    loadInitialBalance();
    loadData();
    render();
  }

  function loadInitialBalance() {
    let bal = localStorage.getItem('initialBalance_' + currentUser);
    if(bal === null) {
      bal = prompt('請輸入帳戶初始餘額(預設0)', '0');
      if(bal === null || isNaN(parseFloat(bal))) bal = '0';
      localStorage.setItem('initialBalance_' + currentUser, bal);
    }
    initialBalance = parseFloat(bal);
    document.getElementById('initial-balance').textContent = initialBalance.toLocaleString();
  }

  function saveInitialBalance(newBalance) {
    initialBalance = newBalance;
    localStorage.setItem('initialBalance_' + currentUser, initialBalance);
    document.getElementById('initial-balance').textContent = initialBalance.toLocaleString();
  }

  function logout() {
    if(confirm('確定要登出嗎？')) {
      currentUser = null;
      records = [];
      editingIndex = -1;
      initialBalance = 0;
      document.getElementById('login-area').style.display = 'block';
      document.getElementById('app-area').style.display = 'none';
      document.getElementById('login-username').value = '';
      clearInputs();
    }
  }

  function loadData() {
    const dataStr = localStorage.getItem('records_' + currentUser);
    if(dataStr) {
      records = JSON.parse(dataStr);
    } else {
      records = [];
    }
  }

  function saveData() {
    localStorage.setItem('records_' + currentUser, JSON.stringify(records));
  }

  function clearInputs() {
    document.getElementById('type').value = 'income';
    document.getElementById('category').value = '食物';
    document.getElementById('amount').value = '';
    document.getElementById('note').value = '';
    editingIndex = -1;
    document.querySelector('button[onclick="addRecord()"]').textContent = '新增';
  }

  function addRecord() {
    const type = document.getElementById('type').value;
    const category = document.getElementById('category').value;
    const amount = parseFloat(document.getElementById('amount').value);
    const note = document.getElementById('note').value.trim();
    const date = new Date().toISOString().split('T')[0];

    if(isNaN(amount) || amount <= 0) {
      alert('請輸入有效金額');
      return;
    }

    if(editingIndex === -1) {
      records.push({type, category, amount, note, date});
    } else {
      records[editingIndex] = {type, category, amount, note, date};
      editingIndex = -1;
      document.querySelector('button[onclick="addRecord()"]').textContent = '新增';
    }

    saveData();
    render();
    clearInputs();
  }

  function render() {
    const tbody = document.getElementById('record-table-body');
    tbody.innerHTML = '';
    let totalIncome = 0;
    let totalCost = 0;
    let categoryTotals = {};

    records.forEach((r, i) => {
      let tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.type==='income'?'收入':'支出'}</td>
        <td>${r.category}</td>
        <td>${r.amount}</td>
        <td>${r.note}</td>
        <td>
          <button class="btn-small btn-edit" onclick="editRecord(${i})">✏️</button>
          <button class="btn-small btn-delete" onclick="deleteRecord(${i})">🗑️</button>
        </td>
      `;
      tbody.appendChild(tr);

      if(r.type === 'income') totalIncome += r.amount;
      else totalCost += r.amount;

      if(!categoryTotals[r.category]) categoryTotals[r.category] = 0;
      categoryTotals[r.category] += (r.type === 'income' ? r.amount : -r.amount);
    });

    document.getElementById('total-income').textContent = totalIncome.toLocaleString();
    document.getElementById('total-cost').textContent = totalCost.toLocaleString();
    const profit = totalIncome - totalCost;
    document.getElementById('total-profit').textContent = profit.toLocaleString();

    // 目前餘額 = 初始餘額 + 利潤
    const currentBalance = initialBalance + profit;
    document.getElementById('current-balance').textContent = currentBalance.toLocaleString();

    drawChart(categoryTotals);
  }

  function editRecord(index) {
    const r = records[index];
    document.getElementById('type').value = r.type;
    document.getElementById('category').value = r.category;
    document.getElementById('amount').value = r.amount;
    document.getElementById('note').value = r.note;
    editingIndex = index;
    document.querySelector('button[onclick="addRecord()"]').textContent = '更新';
  }

  function deleteRecord(index) {
    if(confirm('確定刪除此筆記錄嗎？')) {
      records.splice(index,1);
      saveData();
      render();
    }
  }

  function drawChart(data) {
    const labels = Object.keys(data);
    const values = labels.map(k => Math.abs(data[k]));
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(document.getElementById('pieChart'), {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: ['#f44336', '#2196f3', '#ff9800', '#4caf50', '#9c27b0', '#00bcd4']
        }]
      }
    });
  }
</script>

</div>
</body>
</html>
